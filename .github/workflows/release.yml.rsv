name: Publish

on:
  workflow_dispatch:
    inputs:
      release-title:
        description: 'Release Title'
        required: false
      version:
        description: 'App Version'
        required: true

env:
  GOLANG_VERSION: "1.20"
  GOLANG_LINT_VERSION: "v1.52.2"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NEXT_VERSION: ${{github.ref_name}}

    steps:
      - uses: actions/checkout@v3

      - name: Bump version
        run: ./.github/scripts/bumpVersion.sh
        env:
          VERSION: ${{ inputs.version }}

      - name: Commit version bump
        uses: EndBug/add-and-commit@v7
        with:
          add: ./gradle.properties
          message: ${{ format('[CI] Bump version to {0}', inputs.version) }}
          branch: main

      - name: Setup Golang
        uses: actions/setup-go@v3
        with:
          go-version: ${{ env.GOLANG_VERSION }}

      - name: Caches
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build binary
        env:
          OS: linux
          COMMIT: ${{ needs.prepare.outputs.commit }}
          BRANCH: ${{ needs.prepare.outputs.branch }}
        run: |
          touch .env
          make build

      - uses: ncipollo/release-action@v1
        with:
          artifacts: "./app"
          name: ${{ github.event.inputs.release-title }}
          tag: ${{ github.event.inputs.version }}
